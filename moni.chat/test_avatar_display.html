<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒæ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #ddd;
        }
        .user-info {
            flex: 1;
        }
        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .user-id {
            font-size: 12px;
            color: #666;
        }
        .avatar-url {
            font-size: 10px;
            color: #999;
            word-break: break-all;
            margin-top: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ å¤´åƒæ˜¾ç¤ºæµ‹è¯•</h1>
        
        <div id="status" class="status loading">
            æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...
        </div>
        
        <button onclick="loadUserData()">ğŸ”„ é‡æ–°åŠ è½½</button>
        <button onclick="testAvatarUrls()">ğŸ”— æµ‹è¯•å¤´åƒé“¾æ¥</button>
        
        <div id="userList"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIwMWM4N2QwOC00ZDA1LTRlYjktYjBjYS05MmJjOWNhMjM1YTkiLCJhY2NvdW50IjoiYm9iIiwiaWF0IjoxNzU5MDU0MDMzLCJleHAiOjE3NTk2NTg4MzN9.wZsBzbdfpnIWcN1U98UbckzcwamMw6PaiROdXjrlFKk';
        
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        async function loadUserData() {
            updateStatus('æ­£åœ¨è·å–ç”¨æˆ·æ•°æ®...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/user/list/map`, {
                    headers: {
                        'x-token': TOKEN,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('APIå“åº”:', data);
                
                if (data.code === 200) {
                    displayUsers(data.data);
                    updateStatus(`âœ… æˆåŠŸåŠ è½½ ${Object.keys(data.data).length} ä¸ªç”¨æˆ·`, 'success');
                } else {
                    throw new Error(data.msg || 'APIè¿”å›é”™è¯¯');
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                updateStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function displayUsers(userMap) {
            const userListEl = document.getElementById('userList');
            userListEl.innerHTML = '';
            
            Object.entries(userMap).forEach(([userId, userData]) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const avatarUrl = userData.avatar || userData.portrait || '';
                const hasAvatar = !!avatarUrl;
                const isCartoonAvatar = avatarUrl.includes('dicebear.com');
                
                userItem.innerHTML = `
                    <img src="${avatarUrl}" 
                         class="user-avatar" 
                         alt="${userData.name}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                         style="display: ${hasAvatar ? 'block' : 'none'}">
                    <div class="user-avatar" style="display: ${hasAvatar ? 'none' : 'block'}; background-color: #ddd; text-align: center; line-height: 46px; font-size: 20px;">
                        ${userData.name ? userData.name.charAt(0) : '?'}
                    </div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || 'æœªçŸ¥ç”¨æˆ·'}</div>
                        <div class="user-id">ID: ${userId}</div>
                        <div class="avatar-url">å¤´åƒ: ${avatarUrl || 'æ— å¤´åƒ'}</div>
                        <div style="font-size: 10px; color: ${isCartoonAvatar ? 'green' : 'red'};">
                            ${hasAvatar ? (isCartoonAvatar ? 'âœ… å¡é€šå¤´åƒ' : 'âš ï¸ éå¡é€šå¤´åƒ') : 'âŒ æ— å¤´åƒ'}
                        </div>
                    </div>
                `;
                
                userListEl.appendChild(userItem);
            });
        }
        
        async function testAvatarUrls() {
            updateStatus('æ­£åœ¨æµ‹è¯•å¤´åƒé“¾æ¥...', 'loading');
            
            const userListEl = document.getElementById('userList');
            const avatars = userListEl.querySelectorAll('.user-avatar[src]');
            
            let successCount = 0;
            let totalCount = avatars.length;
            
            for (let avatar of avatars) {
                try {
                    const response = await fetch(avatar.src, { method: 'HEAD' });
                    if (response.ok) {
                        successCount++;
                        avatar.style.borderColor = 'green';
                    } else {
                        avatar.style.borderColor = 'red';
                    }
                } catch (error) {
                    avatar.style.borderColor = 'red';
                }
            }
            
            updateStatus(`ğŸ”— å¤´åƒé“¾æ¥æµ‹è¯•å®Œæˆ: ${successCount}/${totalCount} ä¸ªé“¾æ¥å¯è®¿é—®`, 
                        successCount === totalCount ? 'success' : 'error');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        window.addEventListener('load', loadUserData);
    </script>
</body>
</html>
