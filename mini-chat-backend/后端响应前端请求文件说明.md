# åç«¯å“åº”å‰ç«¯è¯·æ±‚çš„æ–‡ä»¶è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

åç«¯ä½¿ç”¨ **Express.js** æ¡†æ¶ï¼Œæ‰€æœ‰å“åº”å‰ç«¯ HTTP è¯·æ±‚çš„æ–‡ä»¶éƒ½åœ¨ `routes/` ç›®å½•ä¸‹ï¼Œè¿™äº›è·¯ç”±æ–‡ä»¶ä¼šè°ƒç”¨ `controllers/` ç›®å½•ä¸‹çš„æ§åˆ¶å™¨å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

```
mini-chat-backend/
â”œâ”€â”€ app.js                    # ä¸»å…¥å£æ–‡ä»¶ï¼Œæ³¨å†Œæ‰€æœ‰è·¯ç”±
â”œâ”€â”€ server.js                 # å¤‡ç”¨å…¥å£æ–‡ä»¶
â”œâ”€â”€ routes/                    # è·¯ç”±æ–‡ä»¶ï¼ˆå“åº”å‰ç«¯è¯·æ±‚ï¼‰
â”‚   â”œâ”€â”€ user.js               # ç”¨æˆ·ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ message.js             # æ¶ˆæ¯ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ friend.js             # å¥½å‹ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ chatList.js           # èŠå¤©åˆ—è¡¨æ¥å£
â”‚   â”œâ”€â”€ chatGroup.js          # ç¾¤èŠç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ privateChat.js        # ç§èŠç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ fileRoutes.js         # æ–‡ä»¶ä¼ è¾“æ¥å£
â”‚   â”œâ”€â”€ fileUpload.js         # æ–‡ä»¶ä¸Šä¼ æ¥å£
â”‚   â”œâ”€â”€ userSearch.js         # ç”¨æˆ·æœç´¢æ¥å£
â”‚   â”œâ”€â”€ videoCall.js          # è§†é¢‘é€šè¯æ¥å£
â”‚   â””â”€â”€ webrtc.js             # WebRTC ç›¸å…³æ¥å£
â”œâ”€â”€ controllers/              # æ§åˆ¶å™¨ï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ authController.js     # è®¤è¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ userController.js      # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ messageController.js   # æ¶ˆæ¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ friendController.js    # å¥½å‹æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ chatListController.js  # èŠå¤©åˆ—è¡¨æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ fileController.js      # æ–‡ä»¶æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ userSearchController.js # ç”¨æˆ·æœç´¢æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ videoCallController.js # è§†é¢‘é€šè¯æ§åˆ¶å™¨
â”‚   â””â”€â”€ webrtcController.js   # WebRTC æ§åˆ¶å™¨
â”œâ”€â”€ middleware/               # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.js               # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ upload.js             # æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
    â””â”€â”€ response.js           # ç»Ÿä¸€å“åº”æ ¼å¼å·¥å…·
```

## ğŸ¯ è·¯ç”±æ³¨å†Œï¼ˆapp.js ç¬¬ 74-84 è¡Œï¼‰

æ‰€æœ‰è·¯ç”±éƒ½åœ¨ `app.js` ä¸­æ³¨å†Œï¼š

```javascript
// è·¯ç”±æ³¨å†Œ
app.use('/api/v1/user', userRoutes);              // ç”¨æˆ·ç›¸å…³
app.use('/api/v1/message', messageRoutes);        // æ¶ˆæ¯ç›¸å…³
app.use('/api/v1/file', fileRoutes);              // æ–‡ä»¶ä¼ è¾“
app.use('/api/v1/friend', friendRoutes);          // å¥½å‹ç›¸å…³
app.use('/api/v1/chat-list', chatListRoutes);      // èŠå¤©åˆ—è¡¨
app.use('/api/v1/chat-group', chatGroupRoutes);   // ç¾¤èŠç›¸å…³
app.use('/api/v1/private-chat', privateChatRoutes); // ç§èŠç›¸å…³
app.use('/api/v1/common', fileUploadRoutes);      // æ–‡ä»¶ä¸Šä¼ 
app.use('/api/v1/file', webrtcRoutes);           // WebRTC
app.use('/api/v1/call', videoCallRoutes);         // è§†é¢‘é€šè¯
app.use('/api/v1/user-search', userSearchRoutes); // ç”¨æˆ·æœç´¢
```

## ğŸ“ è¯¦ç»†æ–‡ä»¶è¯´æ˜

### 1. **routes/user.js** - ç”¨æˆ·ç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/user`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/user/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/v1/user/login` - ç”¨æˆ·ç™»å½•
- `POST /api/v1/user/logout` - ç”¨æˆ·é€€å‡º
- `GET /api/v1/user/info` - è·å–ç”¨æˆ·ä¿¡æ¯
- `PUT /api/v1/user/info` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `GET /api/v1/user/list` - è·å–ç”¨æˆ·åˆ—è¡¨
- `GET /api/v1/user/list/map` - è·å–ç”¨æˆ·æ˜ å°„è¡¨
- `GET /api/v1/user/online/web` - è·å–åœ¨çº¿ç”¨æˆ·

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/authController.js`

---

### 2. **routes/message.js** - æ¶ˆæ¯ç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/message`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/message/send` - å‘é€æ¶ˆæ¯
- `POST /api/v1/message/send/group` - å‘é€ç¾¤èŠæ¶ˆæ¯
- `POST /api/v1/message/send/private` - å‘é€ç§èŠæ¶ˆæ¯
- `GET /api/v1/message/list` - è·å–æ¶ˆæ¯åˆ—è¡¨
- `GET /api/v1/message/chat-list` - è·å–èŠå¤©åˆ—è¡¨
- `GET /api/v1/message/group-list` - è·å–ç¾¤èŠåˆ—è¡¨
- `GET /api/v1/message/private-list` - è·å–ç§èŠåˆ—è¡¨
- `POST /api/v1/message/mark-read` - æ ‡è®°æ¶ˆæ¯å·²è¯»

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/messageController.js`

---

### 3. **routes/friend.js** - å¥½å‹ç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/friend`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/friend/request` - å‘é€å¥½å‹ç”³è¯·
- `GET /api/v1/friend/requests` - è·å–å¥½å‹ç”³è¯·åˆ—è¡¨
- `POST /api/v1/friend/accept` - æ¥å—å¥½å‹ç”³è¯·
- `POST /api/v1/friend/reject` - æ‹’ç»å¥½å‹ç”³è¯·
- `GET /api/v1/friend/list` - è·å–å¥½å‹åˆ—è¡¨
- `DELETE /api/v1/friend/:friendId` - åˆ é™¤å¥½å‹

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/friendController.js`

---

### 4. **routes/chatList.js** - èŠå¤©åˆ—è¡¨æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/chat-list`

**ä¸»è¦æ¥å£**ï¼š
- `GET /api/v1/chat-list` - è·å–èŠå¤©åˆ—è¡¨
- `POST /api/v1/chat-list/read` - æ ‡è®°å·²è¯»

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/chatListController.js`

---

### 5. **routes/chatGroup.js** - ç¾¤èŠç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/chat-group`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/chat-group/create` - åˆ›å»ºç¾¤èŠ
- `GET /api/v1/chat-group/list` - è·å–ç¾¤èŠåˆ—è¡¨
- `GET /api/v1/chat-group/:groupId` - è·å–ç¾¤èŠè¯¦æƒ…
- `POST /api/v1/chat-group/:groupId/join` - åŠ å…¥ç¾¤èŠ
- `POST /api/v1/chat-group/:groupId/leave` - é€€å‡ºç¾¤èŠ
- `POST /api/v1/chat-group/:groupId/members` - è·å–ç¾¤æˆå‘˜

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/chatListController.js` æˆ–ç›´æ¥åœ¨è·¯ç”±ä¸­å¤„ç†

---

### 6. **routes/privateChat.js** - ç§èŠç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/private-chat`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/private-chat/create` - åˆ›å»ºç§èŠæˆ¿é—´
- `GET /api/v1/private-chat/list` - è·å–ç§èŠåˆ—è¡¨
- `GET /api/v1/private-chat/:roomId` - è·å–ç§èŠæˆ¿é—´ä¿¡æ¯

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/privateChatController.js`

---

### 7. **routes/fileRoutes.js** - æ–‡ä»¶ä¼ è¾“æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/file`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/file/send` - å‘é€æ–‡ä»¶
- `GET /api/v1/file/:fileId` - è·å–æ–‡ä»¶ä¿¡æ¯
- `GET /api/v1/file/download/:fileId` - ä¸‹è½½æ–‡ä»¶

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/fileController.js`

---

### 8. **routes/fileUpload.js** - æ–‡ä»¶ä¸Šä¼ æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/common`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/common/upload` - ä¸Šä¼ æ–‡ä»¶ï¼ˆå¤´åƒç­‰ï¼‰

**å¯¹åº”æ§åˆ¶å™¨**ï¼šç›´æ¥åœ¨è·¯ç”±ä¸­å¤„ç†æˆ–ä½¿ç”¨ä¸­é—´ä»¶

---

### 9. **routes/userSearch.js** - ç”¨æˆ·æœç´¢æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/user-search`

**ä¸»è¦æ¥å£**ï¼š
- `GET /api/v1/user-search` - æœç´¢ç”¨æˆ·

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/userSearchController.js`

---

### 10. **routes/videoCall.js** - è§†é¢‘é€šè¯æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/call`

**ä¸»è¦æ¥å£**ï¼š
- `POST /api/v1/call/start` - å¼€å§‹è§†é¢‘é€šè¯
- `POST /api/v1/call/end` - ç»“æŸè§†é¢‘é€šè¯
- `GET /api/v1/call/status` - è·å–é€šè¯çŠ¶æ€

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/videoCallController.js`

---

### 11. **routes/webrtc.js** - WebRTC ç›¸å…³æ¥å£

**API è·¯å¾„å‰ç¼€**ï¼š`/api/v1/file`ï¼ˆæ³¨æ„ï¼šä¸ fileRoutes å…±äº«å‰ç¼€ï¼‰

**ä¸»è¦æ¥å£**ï¼š
- WebRTC ä¿¡ä»¤ç›¸å…³æ¥å£

**å¯¹åº”æ§åˆ¶å™¨**ï¼š`controllers/webrtcController.js`

---

## ğŸ”§ è¾…åŠ©æ–‡ä»¶

### **utils/response.js** - ç»Ÿä¸€å“åº”æ ¼å¼

**ä½œç”¨**ï¼šæ‰€æœ‰æ§åˆ¶å™¨éƒ½åº”è¯¥ä½¿ç”¨è¿™ä¸ªå·¥å…·å‡½æ•°æ¥å‘é€å“åº”ï¼Œç¡®ä¿å“åº”æ ¼å¼ä¸€è‡´ã€‚

**ä¸»è¦å‡½æ•°**ï¼š
- `sendSuccess(res, data, message, code)` - å‘é€æˆåŠŸå“åº”
- `sendError(res, message, code, data, error)` - å‘é€é”™è¯¯å“åº”

**å“åº”æ ¼å¼**ï¼š
```javascript
{
  code: 200,        // çŠ¶æ€ç 
  message: 'æ“ä½œæˆåŠŸ', // æ¶ˆæ¯
  data: []          // æ•°æ®ï¼ˆæ•°ç»„æˆ–å¯¹è±¡ï¼‰
}
```

---

### **middleware/auth.js** - è®¤è¯ä¸­é—´ä»¶

**ä½œç”¨**ï¼šéªŒè¯ç”¨æˆ· tokenï¼Œä¿æŠ¤éœ€è¦ç™»å½•çš„æ¥å£ã€‚

**ä½¿ç”¨æ–¹å¼**ï¼š
```javascript
router.get('/info', auth, authController.getUserInfo);
//                      â†‘
//                  è®¤è¯ä¸­é—´ä»¶
```

---

## ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹

```
å‰ç«¯å‘èµ·è¯·æ±‚
    â†“
app.js è·¯ç”±åŒ¹é…ï¼ˆç¬¬ 74-84 è¡Œï¼‰
    â†“
routes/xxx.js è·¯ç”±å¤„ç†
    â†“
middleware/auth.js è®¤è¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
    â†“
controllers/xxxController.js ä¸šåŠ¡é€»è¾‘
    â†“
models/xxx.js æ•°æ®åº“æ“ä½œ
    â†“
utils/response.js æ ¼å¼åŒ–å“åº”
    â†“
è¿”å› JSON å“åº”ç»™å‰ç«¯
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ‰€æœ‰è·¯ç”±éƒ½åœ¨ `app.js` ä¸­æ³¨å†Œ**ï¼Œæ–°å¢è·¯ç”±éœ€è¦åœ¨è¿™é‡Œæ·»åŠ 
2. **ç»Ÿä¸€ä½¿ç”¨ `utils/response.js`** å‘é€å“åº”ï¼Œç¡®ä¿æ ¼å¼ä¸€è‡´
3. **éœ€è¦ç™»å½•çš„æ¥å£**ä½¿ç”¨ `auth` ä¸­é—´ä»¶ä¿æŠ¤
4. **WebSocket è¿æ¥**åœ¨ `config/ws.js` ä¸­å¤„ç†ï¼Œä¸æ˜¯ HTTP è¯·æ±‚
5. **é™æ€æ–‡ä»¶**ï¼ˆå¦‚å¤´åƒï¼‰é€šè¿‡ `app.use('/uploads', express.static('uploads'))` æä¾›

## ğŸ¯ æ€»ç»“

**å“åº”å‰ç«¯è¯·æ±‚çš„æ–‡ä»¶**ï¼š
- âœ… `routes/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.js` æ–‡ä»¶ï¼ˆ11ä¸ªè·¯ç”±æ–‡ä»¶ï¼‰
- âœ… `controllers/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.js` æ–‡ä»¶ï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… `middleware/auth.js`ï¼ˆè®¤è¯ä¸­é—´ä»¶ï¼‰
- âœ… `utils/response.js`ï¼ˆç»Ÿä¸€å“åº”æ ¼å¼ï¼‰
- âœ… `app.js`ï¼ˆæ³¨å†Œè·¯ç”±çš„ä¸»å…¥å£ï¼‰

**ä¸å“åº”å‰ç«¯è¯·æ±‚çš„æ–‡ä»¶**ï¼š
- âŒ `models/` ç›®å½•ï¼ˆæ•°æ®æ¨¡å‹ï¼Œä¸ç›´æ¥å“åº”è¯·æ±‚ï¼‰
- âŒ `migrations/` ç›®å½•ï¼ˆæ•°æ®åº“è¿ç§»è„šæœ¬ï¼‰
- âŒ `scripts/` ç›®å½•ï¼ˆå·¥å…·è„šæœ¬ï¼‰
- âŒ `config/` ç›®å½•ï¼ˆé…ç½®æ–‡ä»¶ï¼Œä½† `config/ws.js` å¤„ç† WebSocketï¼‰

